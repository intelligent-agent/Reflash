#!/bin/bash
set -e
set -x

set_progress () {
  echo $1 >> /tmp/recore-flash-progress
}

set_info() {
  echo "$1" >> /tmp/recore-flash-log
  logger "$1"
}

echo "0" > /tmp/recore-flash-progress
echo "Recore eMMC backup" >  /tmp/recore-flash-log
echo "------------------" >> /tmp/recore-flash-log

OUTFILE=$1
INFILE="/dev/mmcblk0"
OUTIMG=${OUTFILE}.img

set_info "Creating empty image"
set_progress 1
truncate -s 5G ${OUTIMG}

DEVICE=`losetup -P -f --show $OUTIMG`

cat <<EOF > image.layout
# partition table of ${DEVICE}
unit: sectors

${DEVICE}p1 : start=8192, size=524288, type=83
${DEVICE}p2 : start=532480, size=9303520, type=83
EOF

sfdisk ${DEVICE} < image.layout
set_info "Creating filesystem"
set_progress 2
sudo mkfs -t ext4 ${DEVICE}p1
sudo mkfs -t ext4 ${DEVICE}p2

set_info "Installing u-boot"
set_progress 3
dd if=/opt/reflash/u-boot/u-boot-sunxi-with-spl.bin of=${DEVICE} bs=1024 seek=8

INP1=/mnt/reflash/inp1
INP2=/mnt/reflash/inp2
OUTP1=/mnt/reflash/outp1
OUTP2=/mnt/reflash/outp2
mkdir -p ${INP1}
mkdir -p ${INP2}
mkdir -p ${OUTP1}
mkdir -p ${OUTP2}
umount -d /mnt/reflash/* || /bin/true

mount ${INFILE}p1 ${INP1}
mount ${INFILE}p2 ${INP2}
mount ${DEVICE}p1 ${OUTP1}
mount ${DEVICE}p2 ${OUTP2}
set_info "Copying files to partition 1"
set_progress 10
rsync -axHAWXS --numeric-ids ${INP1}/* ${OUTP1}
set_info "Copying files to partition 2"
set_progress 12
rsync -axHAWXS --numeric-ids ${INP2}/* ${OUTP2}
sync
set_info "Unmounting partitions"
set_progress 50
umount /mnt/reflash/*
losetup -d ${DEVICE}
set_info "Compressing image"
set_progress 51
xz -v -0 -T 0 -f ${OUTIMG}
sync
set_info "Backup complete"
set_progress 100
