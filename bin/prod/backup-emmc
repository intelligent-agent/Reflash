#!/bin/bash
set -euo pipefail

info() {
    echo "[info] $1" >> /var/log/reflash.log
    echo "$1"
}

info "Starting Recore eMMC backup script"
info "----------------------------------"

OUTFILE=$1
INFILE="/dev/"`lsblk -n -o NAME | grep 'mmcblk[0-2]$'`
OUTIMG=${OUTFILE}.img.xz
SIZE=`lsblk -n -d -o SIZE --bytes $INFILE`

info "Copying block device $INFILE"
info "Resulting image name $OUTIMG"
info "Uncompressed file size is $SIZE bytes"

mount | grep '/dev/mmcblk' | cut -f 1 -d' ' | xargs -t -r -n 1 umount
info "Starting copy"
(dd if=${INFILE} | pv -f -n -b | xz -0 -T 0 -f > ${OUTIMG}) 2>&1 > /dev/null | unbuffer -p awk '{printf "%.2f\n", 100*($1/'$SIZE') }' > /tmp/recore-flash-progress
info "Syncing drives"
sync
info "Backup script complete"
