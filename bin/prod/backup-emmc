#!/bin/bash
set -o pipefail

handle_error() {
    echo "Error $1 occurred on line $2" | tee >(systemd-cat -t reflash -p err)
    exit $1
}

info() {
    echo "$1" | tee >(systemd-cat -t reflash -p info)
}

trap 'handle_error $? $LINENO' ERR

info "Starting Recore eMMC backup script"
info "----------------------------------"

OUTFILE=$1
INFILE="/dev/"`lsblk -n -o NAME | grep 'mmcblk[0-2]$'`
OUTIMG=${OUTFILE}.img.xz
SIZE=`lsblk -n -d -o SIZE --bytes $INFILE`

info "Copying block device $INFILE"
info "Resulting image name $OUTIMG"
info "Uncompressed file size is $SIZE bytes"

mount | grep '/dev/mmcblk' | cut -f 1 -d' ' | xargs -t -r -n 1 umount
info "Starting copy"
(dd if=${INFILE} | pv -f -n -b | xz -0 -T 0 -f > ${OUTIMG}) 2>&1 > /dev/null | unbuffer -p awk '{printf "%.2f\n", 100*($1/'$SIZE') }' > /tmp/recore-flash-progress
info "Syncing drives"
sync
info "Backup script complete"
