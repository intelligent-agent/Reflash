#!/bin/bash

INFILE=$1

OUTFILE="/dev/"`lsblk -n -o NAME | grep 'mmcblk[0-2]$'`

partprobe

mkdir -p /mnt/config
if ! grep -qs '/mnt/config ' /proc/mounts; then
    mount -r ${OUTFILE}boot0p1 /mnt/config/
fi

CONFIG=`ls /mnt/config/*.json`
REVISION=`cat "$CONFIG" | jq -r ".Revision" | tr '[:upper:]' '[:lower:]'`

mount | grep '/dev/mmcblk' | cut -f 1 -d' ' | xargs -t -r -n 1 umount
(xz -d -c ${INFILE} | pv -f -n -b | dd of=${OUTFILE}) 2>/tmp/recore-flash-progress
sync

# Re-read partition table
partprobe ${OUTFILE}

# Create new uuids so they are different than the USB drive
tune2fs -U random ${OUTFILE}p1
tune2fs -U random ${OUTFILE}p2

UUID1=`blkid -s UUID -o value ${OUTFILE}p1`
UUID2=`blkid -s UUID -o value ${OUTFILE}p2`

mkdir -p /mnt/emmc
# mount and exchange UUID
mount ${OUTFILE}p2 /mnt/emmc
sed -i "s:UUID=.* \/ :UUID=${UUID2} / :" /mnt/emmc/etc/fstab
sed -i "s:UUID=.* \/boot :UUID=${UUID1} /boot :" /mnt/emmc/etc/fstab

# Copy config file, if one is not already present
cd /mnt/emmc/home/debian/
if ! test -f printer_data/config/printer.cfg
  if test -f klipper/config/generic-recore-$REVISION.cfg; then
    cp klipper/config/generic-recore-$REVISION.cfg printer_data/config/printer.cfg
  fi
  # Enable mainsail on mainsail distro
  if test -f printer_data/config/mainsail.cfg; then
    sed -i 's/\#\[include mainsail.cfg\]/\[include mainsail.cfg\]/' printer_data/config/printer.cfg
  fi
fi
cd
umount ${OUTFILE}p2

mount ${OUTFILE}p1 /mnt/emmc
sed -i "s:^rootdev=.*:rootdev=UUID=${UUID2}:" /mnt/emmc/armbianEnv.txt
cd /mnt/emmc/dtb/allwinner/
if test -f sun50i-a64-recore-$REVISION.dtb; then
  ln -sf sun50i-a64-recore-$REVISION.dtb sun50i-a64-recore.dtb
fi
cd
umount ${OUTFILE}p1

sync
