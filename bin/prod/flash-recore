#!/bin/bash
set -o pipefail

handle_error() {
    echo "Error $1 occurred on line $2" | tee >(systemd-cat -t reflash -p err)
    exit $1
}

info() {
    echo "$1" | tee >(systemd-cat -t reflash -p info)
}

trap 'handle_error $? $LINENO' ERR

info "Starting recore flash script"
info "------------------"

INFILE=$1
OUTFILE="/dev/"`lsblk -n -o NAME | grep 'mmcblk[0-2]$'`

if ! test -b ${OUTFILE}boot0p1; then
    partx -a ${OUTFILE}boot0
fi

mkdir -p /mnt/config
if ! grep -qs '/mnt/config ' /proc/mounts; then
    mount -r ${OUTFILE}boot0p1 /mnt/config/
fi

CONFIG=`ls /mnt/config/*.json`
REVISION=`cat "$CONFIG" | jq -r ".Revision" | tr '[:upper:]' '[:lower:]'`
SIZE=`xz -lv $INFILE | grep Uncompressed | sed 's/[,(]//g' | awk '{ printf "%s\n", $5 }'`

info "Found Recore hardware revision $REVISION"
info "Flashing file name $INFILE"
info "Overwriting block device $OUTFILE"
info "Uncompressed file size is $SIZE bytes"

mount | grep '/dev/mmcblk' | cut -f 1 -d' ' | xargs -t -r -n 1 umount
info "Starting flashing..."
(xz -T 0 -d -c ${INFILE} | pv -f -n -b | dd of=${OUTFILE} status=none) 2>&1 | unbuffer -p awk '{printf "%f\n", 100*($1/'$SIZE') }' > /tmp/recore-flash-progress
info "Flashing done"
info "Syncing drives"
sync

# Re-read partition table
partprobe ${OUTFILE}

info "Checking filesystems"
e2fsck -y -f ${OUTFILE}p1
e2fsck -y -f ${OUTFILE}p2

# Create new uuids so they are different than the USB drive
info "Creating new UUIDs"
tune2fs -U random ${OUTFILE}p1
tune2fs -U random ${OUTFILE}p2

UUID1=`blkid -s UUID -o value ${OUTFILE}p1`
UUID2=`blkid -s UUID -o value ${OUTFILE}p2`

mkdir -p /mnt/emmc
# mount and exchange UUID
mount ${OUTFILE}p2 /mnt/emmc
info "Updating fstab with new UUIDs"
sed -i "s:UUID=.* \/ :UUID=${UUID2} / :" /mnt/emmc/etc/fstab
sed -i "s:UUID=.* \/boot :UUID=${UUID1} /boot :" /mnt/emmc/etc/fstab

# Copy config file, if one is not already present
if test -d /mnt/emmc/home/debian; then
  cd /mnt/emmc/home/debian/
  if ! test -f printer_data/config/printer.cfg; then
    if test -f klipper/config/generic-recore-$REVISION.cfg; then
      info "Installing Klipper config file"
      cp klipper/config/generic-recore-$REVISION.cfg printer_data/config/printer.cfg
      chown 1000:1000 printer_data/config/printer.cfg
    fi
    # Enable mainsail on mainsail distros
    if test -f printer_data/config/mainsail.cfg; then
      info "Including Mainsail in config file, above the first section"
      # Older distros has the include fiel as a comment
      sed -i 's/\#\[include mainsail.cfg\]//' printer_data/config/printer.cfg
      sed -i 's:\(\[recore.*\]\):\[include mainsail.cfg\]\n\n\1:' printer_data/config/printer.cfg
    fi
    # Enable fluidd on fluidd distros
    if test -f printer_data/config/fluidd.cfg; then
      info "Including Fluidd in config file, above the first section"
      # Older distros has the include fiel as a comment
      sed -i 's/\#\[include mainsail.cfg\]//' printer_data/config/printer.cfg
      sed -i 's:\(\[recore.*\]\):\[include fluidd.cfg\]\n\n\1:' printer_data/config/printer.cfg
    fi
  fi
fi
cd
umount ${OUTFILE}p2

mount ${OUTFILE}p1 /mnt/emmc
sed -i "/^rootdev=.*/d" /mnt/emmc/armbianEnv.txt
sed -i '/^$/d' /mnt/emmc/armbianEnv.txt
echo "rootdev=UUID=${UUID2}" >> /mnt/emmc/armbianEnv.txt

cd /mnt/emmc/dtb/allwinner/
if test -f sun50i-a64-recore-$REVISION.dtb; then
  info "Symlinking device tree"
  ln -sf sun50i-a64-recore-$REVISION.dtb sun50i-a64-recore.dtb
fi
cd
umount ${OUTFILE}p1

sync
info "Script done!"
