#!/bin/bash
set -e
set -x

echo "Recore flash script" >  /tmp/recore-flash-log
echo "------------------" >> /tmp/recore-flash-log

INFILE=$1
OUTFILE="/dev/"`lsblk -n -o NAME | grep 'mmcblk[0-2]$'`
partx -a ${OUTFILE}boot0p1

mkdir -p /mnt/config
if ! grep -qs '/mnt/config ' /proc/mounts; then
    mount -r ${OUTFILE}boot0p1 /mnt/config/
fi

CONFIG=`ls /mnt/config/*.json`
REVISION=`cat "$CONFIG" | jq -r ".Revision" | tr '[:upper:]' '[:lower:]'`
SIZE=`xz -lv $INFILE | grep Uncompressed | sed 's/[,(]//g' | awk '{ printf "%s\n", $5 }'`

echo "Found Recore hardware revision $REVISION" >> /tmp/recore-flash-log
echo "Flashing file name $INFILE" >> /tmp/recore-flash-log
echo "Overwriting block device $OUTFILE" >> /tmp/recore-flash-log
echo "Uncompressed file size $SIZE bytes" >> /tmp/recore-flash-log

mount | grep '/dev/mmcblk' | cut -f 1 -d' ' | xargs -t -r -n 1 umount
echo "Starting flashing" >> /tmp/recore-flash-log
(xz -T 0 -d -c ${INFILE} | pv -f -n -b | dd of=${OUTFILE} status=none) 2>&1 | unbuffer -p awk '{printf "%f\n", 100*($1/'$SIZE') }' > /tmp/recore-flash-progress
echo "Flashing complete" >> /tmp/recore-flash-log
sync

# Re-read partition table
partprobe ${OUTFILE}

# Create new uuids so they are different than the USB drive
tune2fs -U random ${OUTFILE}p1
tune2fs -U random ${OUTFILE}p2

UUID1=`blkid -s UUID -o value ${OUTFILE}p1`
UUID2=`blkid -s UUID -o value ${OUTFILE}p2`

mkdir -p /mnt/emmc
# mount and exchange UUID
mount ${OUTFILE}p2 /mnt/emmc
echo "Creating disk UUIDs" >> /tmp/recore-flash-log
sed -i "s:UUID=.* \/ :UUID=${UUID2} / :" /mnt/emmc/etc/fstab
sed -i "s:UUID=.* \/boot :UUID=${UUID1} /boot :" /mnt/emmc/etc/fstab

# Copy config file, if one is not already present
if test -d /mnt/emmc/home/debian; then
  cd /mnt/emmc/home/debian/
  if ! test -f printer_data/config/printer.cfg; then
    if test -f klipper/config/generic-recore-$REVISION.cfg; then
      echo "Installing Klipper config file" >> /tmp/recore-flash-log
      cp klipper/config/generic-recore-$REVISION.cfg printer_data/config/printer.cfg
      chown 1000:1000 printer_data/config/printer.cfg
    fi
    # Enable mainsail on mainsail distros
    if test -f printer_data/config/mainsail.cfg; then
      echo "Including Mainsail in config file" >> /tmp/recore-flash-log
      sed -i 's/\#\[include mainsail.cfg\]/\[include mainsail.cfg\]/' printer_data/config/printer.cfg
    fi
    # Enable fluidd on fluidd distros
    if test -f printer_data/config/fluidd.cfg; then
      echo "Including Fluidd in config file" >> /tmp/recore-flash-log      
      sed -i 's/\#\[include mainsail.cfg\]/\[include fluidd.cfg\]/' printer_data/config/printer.cfg
    fi
  fi
fi
cd
umount ${OUTFILE}p2

mount ${OUTFILE}p1 /mnt/emmc
sed -i "/^rootdev=.*/d" /mnt/emmc/armbianEnv.txt
sed -i '/^$/d' /mnt/emmc/armbianEnv.txt
echo "rootdev=UUID=${UUID2}" >> /mnt/emmc/armbianEnv.txt

cd /mnt/emmc/dtb/allwinner/
if test -f sun50i-a64-recore-$REVISION.dtb; then
  echo "Symlinking device tree" >> /tmp/recore-flash-log
  ln -sf sun50i-a64-recore-$REVISION.dtb sun50i-a64-recore.dtb
fi
cd
umount ${OUTFILE}p1

echo "Script done!" >> /tmp/recore-flash-log
sync
