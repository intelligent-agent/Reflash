#!/bin/bash

set -o pipefail

handle_error() {
    echo "[error] $1 occurred on line $2" | tee -a /var/log/reflash.log
    exit $1
}

info() {
    echo "[info] $1" >> /var/log/reflash.log
    echo "$1"
}

trap 'handle_error $? $LINENO' ERR

NEW_MEDIA=$1
EMMC=`lsblk -n -o NAME | grep 'mmcblk[0-2]$'`

PATH_EMMC="/dev/${EMMC}p2"
PATH_USB="/dev/sda2"
UUID_EMMC=`lsblk -o UUID -n $PATH_EMMC 2>/dev/null`
UUID_USB=`lsblk -o UUID -n /dev/sda2 2>/dev/null`

if [ "x${NEW_MEDIA}" == "xusb" ]; then
  NEW_DEV="/dev/sda2"
elif [ "x${NEW_MEDIA}" == "xemmc" ]; then
  NEW_DEV="UUID=$UUID_EMMC"
else
  echo "usage $0 usb/emmc"
  exit 1
fi

KEY="^rootdev=.*$"

mkdir -p /mnt/emmc
if ! mountpoint -q /mnt/emmc
then
  mount "/dev/${EMMC}p1" /mnt/emmc
else
  mount -o remount -rw "/dev/${EMMC}p1" /mnt/emmc
fi

sed -i "s:${KEY}::g" /mnt/emmc/armbianEnv.txt
sed -i '/^$/d' /mnt/emmc/armbianEnv.txt
echo "rootdev=${NEW_DEV}" >> /mnt/emmc/armbianEnv.txt
sync
umount /mnt/emmc

info "Updated rootdev to ${NEW_DEV}"