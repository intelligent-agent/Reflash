#!/bin/bash
set -e
set -x

set_progress () {
  echo "$1" >> /tmp/recore-flash-progress
}

set_info() {
  echo "$1" >> /tmp/recore-flash-log
  logger "$1"
}

echo "0" > /tmp/recore-flash-progress
echo "Recore eMMC backup" >  /tmp/recore-flash-log
echo "------------------" >> /tmp/recore-flash-log

OUTFILE=$1
#INFILE="/opt/reflash/sde"
OUTIMG=${OUTFILE}.img
set_info "Creating empty image"
dd if=/dev/zero of=${OUTIMG} bs=1M count=5000

DEVICE=`losetup -P -f --show $OUTIMG`
PARTITION=${DEVICE}p2

cat <<EOF > image.layout
# partition table of ${DEVICE}
unit: sectors

${DEVICE}p1 : start=8192, size=524288, type=83
${DEVICE}p2 : start=532480, size=9303520, type=83
EOF

sfdisk ${DEVICE} < image.layout

sudo mkfs -t ext4 ${DEVICE}p1
sudo mkfs -t ext4 ${DEVICE}p2

INP1=/opt/reflash/sde1
INP2=/opt/reflash/sde2
OUTP1=/mnt/reflash/outp1
OUTP2=/mnt/reflash/outp2
mkdir -p ${INP1}
mkdir -p ${INP2}
mkdir -p ${OUTP1}
mkdir -p ${OUTP2}
#mount ${INFILE}1 ${INP1}
#mount ${INFILE}2 ${INP2}
mount ${DEVICE}p1 ${OUTP1}
mount ${DEVICE}p2 ${OUTP2}
set_info "Copying files to partition 1"
set_progress 3
rsync -axHAWXS --numeric-ids --info=progress2 ${INP1}/* ${OUTP1}
set_info "Copying files to partition 2"

set_progress 10
#rsync -axHAWXS --numeric-ids --info=progress2 ${INP2}/* ${OUTP2}
sync
set_progress 50
set_info "Compressing image"
umount /mnt/reflash/outp*
losetup -d ${DEVICE}
xz -v -0 -T0 -f ${OUTIMG}
set_progress 100
set_info "Backup complete"
#INFILE="/dev/random"
#(dd if=${INFILE} bs=1M count=30 | pv -f -n -b | xz > ${OUTFILE}) 2>/tmp/recore-flash-progress
#sync
