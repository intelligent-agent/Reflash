#!/bin/bash
set -o pipefail

handle_error() {
    echo "Error $1 occurred on line $2" | tee >(systemd-cat -t reflash -p err)
    exit $1
}

info() {
    echo "$1" | tee >(systemd-cat -t reflash -p info)
}

trap 'handle_error $? $LINENO' ERR

info "Recore eMMC backup (dev)"
info "------------------"

OUTFILE=$1
INFILE=".tmp/dev/mmcblk0"
OUTIMG=${OUTFILE}.img.xz
SIZE=$(stat --printf="%s" $INFILE)

info "Copying block device $INFILE"
info "Resulting image name $OUTIMG"
info "Uncompressed file size $SIZE bytes"

info "Starting copy"
(dd if=${INFILE} | pv -f -n -b | xz -0 -T 0 -f > ${OUTIMG}) 2>&1 > /dev/null | unbuffer -p awk '{printf "%.2f\n", 100*($1/'$SIZE') }' > /tmp/recore-flash-progress
info "Backup complete"
sync
