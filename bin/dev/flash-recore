#!/bin/bash
set -o pipefail

handle_error() {
    echo "Error $1 occurred on line $2" | tee >(systemd-cat -t reflash -p err)
    exit $1
}

info() {
    echo "$1" | tee >(systemd-cat -t reflash -p info)
}

trap 'handle_error $? $LINENO' ERR

info "Recore flash script (dev)"
info "------------------"

INFILE=$1
OUTFILE="/dev/zero"
REVISION="A7"


SIZE=`xz -lv $INFILE | grep Uncompressed | sed 's/[,(]//g' | awk '{ printf "%s\n", $5 }'`

info "Found Recore hardware revision $REVISION"
info "Flashing file name $INFILE"
info "Overwriting block device $OUTFILE"
info "Uncompressed file size $SIZE bytes"

info "Starting flashing"
(xz -d -c ${INFILE} | pv -f -n -b | dd of=${OUTFILE} status=none) 2>&1 > /dev/null | unbuffer -p awk '{printf "%.2f\n", 100*($1/'$SIZE') }' > /tmp/recore-flash-progress
info "Flashing complete"
info "Script done!"
